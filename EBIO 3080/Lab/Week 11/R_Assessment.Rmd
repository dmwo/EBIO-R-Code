---
title: "**EBIO 3080 R Assessment**"
author: "Dylan Oh"
date: "5 November 2020"
output:
  html_document:
    df_print: paged
    fig_retina: 1
resource_files:
  - '.'
---

```{r setup, include = FALSE, echo = FALSE}
require("knitr")
knitr::opts_chunk$set(echo = TRUE)
dest = "E:/Documents/GitHub/EBIO-R-Code/EBIO 3080/Lab/Week 11"
opts_knit$set(root.dir = dest)
```

```{r include = FALSE}
library(showtext)
library(ggplot2)
library(htmltools)
library(dplyr)
dest1 <- "C:/Users/Dylan/AppData/Local/Microsoft/Windows/Fonts"
font_add("karla",
         regular = file.path(dest1, "Karla-Regular.ttf"))
```

```{r echo = FALSE}
tags$link(href = "https://fonts.googleapis.com/css?family=Karla:400,700|Fira+Mono&display=fallback", rel = "stylesheet")
```

```{css echo = FALSE}
body {
    font-family: Karla;
    font-size: 12pt;
}
code {
    font-family: "Fira Mono";
}
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This assessment will analyse data on the survival of Galapagos marine iguanas, specifically how body size (quantified by weight in grams) affects selection on the population and the survival of individuals during the 1982-1983 drought on the islands.

### **Analysis of the Data**

```{r echo = FALSE, message = FALSE, warning = FALSE, dpi = 2000, fig.showtext = TRUE, fig.width = 8, fig.height = 6, fig.cap = "**Figure 1: Overlapping histogram comparing weights of all iguanas in a Galapagos population and the weights of the iguanas that survived the drought**. Body size is lower in the entire iguana population (mean: 176.14 g, sd: 66.49 g, median: 163.2 g) than in the surviving iguanas (mean: 226.56 g, sd: 71.28 g, median: 255.0 g)."}
iguana <- read.csv("iguana_survival.csv", fileEncoding = "UTF-8-BOM")
ig_surv <- subset(iguana, survive_died == 1)

fig1 <- ggplot() +
    geom_histogram(data = iguana,
                   color = "white",
                   aes(x = weight, fill = "#e99c9c")) +
    geom_histogram(data = ig_surv,
                   color = "white",
                   aes(x = weight, fill = "#9ba5bd")) +
    geom_vline(xintercept = as.numeric(mean(iguana$weight)),
               color = "#166363", linetype = "dotdash") +
    geom_vline(xintercept = as.numeric(mean(ig_surv$weight)),
               color = "#645a42", linetype = "dotdash") +
    scale_fill_identity(breaks = c("#e99c9c", "#9ba5bd"),
                        labels = c("Pre-Drought",
                                   "Post-Drought"),
                        guide = "legend") +
    scale_x_continuous(breaks = seq(50, 350, 25)) +
    ggtitle("Body Sizes of a Population of Galapagos Marine Iguanas",
            paste("Observations of individuals before and after the",
                  "1982-1983 drought")) +
    xlab("Weight (grams)") +
    ylab("Frequency") +
    theme(plot.title = element_text(color = "#2c3136", size = 18,
                                    family = "karla", vjust = -0.5),
          plot.subtitle = element_text(color = "#2c3136", size = 9,
                                       family = "karla", vjust = -1.6),
          axis.title.x = element_text(color = "#2c3136", size = 13,
                                      family = "karla"),
          axis.title.y = element_text(color = "#2c3136", size = 13,
                                      family = "karla"),
          legend.text = element_text(color = "#2c3136", size = 9,
                                     family = "karla"),
          legend.position = "top",
          legend.justification = "right",
          legend.margin = margin(0,0,0,0),
          legend.box.margin = margin(-10,0,-10,-10),
          legend.key.size = unit(0.8, "line")) +
    labs(fill = "")
print(fig1)
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; From the data, it can be seen that the drought had the effect of greatly increasing the average body size of the iguana population, with a difference of about 50 g. However, the more interesting effect can be seen through the medians; in the survived population, the median weight of the iguanas is higher than the average, whereas in the pre-drought population the median weight was substantially lower than average. The peaks in the histograms indicate that both medium-small and medium-large sizes are favoured in both sample sets. 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Several claims could be made about these data. It is possible that the general patterns observed in both sample sets are the result of high sexual dimorphism, with females occupying the lower-mass region with a peak around 120 g and males occupying the higher-mass region with a peak of around 215 g pre-drought and 260 g post-drought. If that is indeed the case, then the drought had the effect of selecting for larger iguanas, both male and female; this makes some sense from a biological perspective, as during the competition for food that would naturally ensue in their shoreline habitat, larger individuals would have an advantage. The smaller body size movement in the female population could be attributed to high sexual selection, which may encourage smaller females and larger males in this species, and therefore the males became much larger as a result of the drought (positive pressure from sexual selection + positive pressure from the drought), while females stayed mostly the same (negative pressure from sexual selection + positive pressure from the drought). In the next generation, therefore, it would be expected that male and female body sizes would grow further apart from each other, but the average body size would remain higher than it was before the drought. The disparity in median directions would also, under this scenario, imply that the male population grew in proportion after the drought.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If, on the other hand, there is no sexual dimorphism, then these data must necessarily show that there is an evolutionary fitness benefit for both large and small iguanas, which is an example of diversifying selection. The drought, as a result, would add directional selection to only the larger iguanas and not the smaller ones. This could be for any number of reasons. Larger iguanas may have an advantage in seeking mates and competing for resources, while smaller iguanas may compensate for their size by being better suited to avoiding predation, for example. In this scenario, the dramatic reduction in available resources caused by the drought could have forced smaller iguanas to take more risks in obtaining food, thus negating their predation advantage and resulting in an overall selection for larger iguanas.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Regardless of the specific circumstances, it can be concluded that, in general, larger body sizes were selected for as a result of the drought (and perhaps would have occurred even without the drought), which is indicated in the increase in both the mean and median weight of the population. Moreover, diversifying selection acted on the population as well, with the two peaks in weight frequency moving further apart and the middle valley in weight frequency nearly disappearing.

### **R Code**

```{r message = FALSE, warning = FALSE, results = 'hide', fig.show = 'hide'}
# Reading csv data and subsetting survived iguanas
iguana <- read.csv("iguana_survival.csv", fileEncoding = "UTF-8-BOM")
ig_surv <- subset(iguana, survive_died == 1)

# Plotting results
fig1 <- ggplot() +
    # Adding total population histogram
    geom_histogram(data = iguana,
                   color = "white",
                   aes(x = weight, fill = "#e99c9c")) +
    # Overlaying survived iguana histogram
    geom_histogram(data = ig_surv,
                   color = "white",
                   aes(x = weight, fill = "#9ba5bd")) +
    # Adding mean line for total population
    geom_vline(xintercept = as.numeric(mean(iguana$weight)),
               color = "#166363", linetype = "dotdash") +
    # Adding mean line for survived iguanas
    geom_vline(xintercept = as.numeric(mean(ig_surv$weight)),
               color = "#645a42", linetype = "dotdash") +
    # Adding legend
    scale_fill_identity(breaks = c("#e99c9c", "#9ba5bd"),
                        labels = c("Pre-Drought",
                                   "Post-Drought"),
                        guide = "legend") +
    # Adjusting x-axis tick marks
    scale_x_continuous(breaks = seq(50, 350, 25)) +
    # Adding title
    ggtitle("Body Sizes of a Population of Galapagos Marine Iguanas",
            paste("Observations of individuals before and after the",
                  "1982-1983 drought")) +
    # Adding x-axis title
    xlab("Weight (grams)") +
    # Adding y-axis title
    ylab("Frequency") +
    # Changing fonts for plot text, adjusting legend position
    theme(plot.title = element_text(color = "#2c3136", size = 18,
                                    family = "karla", vjust = -0.5),
          plot.subtitle = element_text(color = "#2c3136", size = 9,
                                       family = "karla", vjust = -1.6),
          axis.title.x = element_text(color = "#2c3136", size = 13,
                                      family = "karla"),
          axis.title.y = element_text(color = "#2c3136", size = 13,
                                      family = "karla"),
          legend.text = element_text(color = "#2c3136", size = 9,
                                     family = "karla"),
          legend.position = "top",
          legend.justification = "right",
          legend.margin = margin(0,0,0,0),
          legend.box.margin = margin(-10,0,-10,-10),
          legend.key.size = unit(0.8, "line")) +
    # Removing legend title
    labs(fill = "")
print(fig1)
```

```{r echo = FALSE, message = FALSE, warning = FALSE, dpi = 2000, fig.showtext = TRUE, fig.width = 8, fig.height = 6}
# Reading csv file
setwd("E:/Documents/GitHub/EBIO-R-Code/EBIO 3080/Lab/Final Project")
data <- read.csv("survey_response.csv", fileEncoding = "UTF-8-BOM")

# Renaming columns in the data frame
names(data) <- c("Subject", "Gender", "Age", "Weight",
                 "Pers_Habits", "Pers_Days", "Pers_Amt",
                 "Parent_Drink", "Mother_Days", "Mother_Amt",
                 "Father_Days", "Father_Amt",
                 "Num_Sibs", "Sib1_Drink", "Sib1_Days", "Sib1_Amt",
                 "Sib2_Drink", "Sib2_Days", "Sib2_Amt",
                 "Sib3_Drink", "Sib3_Days", "Sib3_Amt",
                 "Sib4_Drink", "Sib4_Days", "Sib4_Amt",
                 "Sib5_Drink", "Sib5_Days", "Sib5_Amt",
                 "Sib6_Drink", "Sib6_Days", "Sib6_Amt",
                 "Sib7_Drink", "Sib7_Days", "Sib7_Amt",
                 "Sib8_Drink", "Sib8_Days", "Sib8_Amt",
                 "Sib9_Drink", "Sib9_Days", "Sib9_Amt",
                 "Sib10_Drink", "Sib10_Days", "Sib10_Amt",
                 "GP1_Drink", "GP1_Days", "GP1_Amt",
                 "GP2_Drink", "GP2_Days", "GP2_Amt",
                 "GP3_Drink", "GP3_Days", "GP3_Amt",
                 "GP4_Drink", "GP4_Days", "GP4_Amt")

data[data == ""] <- NA

# Replacing all NA/no values in personal drinking habits columns with 0
data$Pers_Days[is.na(data$Pers_Days)] <- 0
data$Pers_Amt[is.na(data$Pers_Amt)] <- "0"

# Locating column of parental drinking habits
par_idx <- match("Parent_Drink", colnames(data))
par_days_idx <- match(c("Mother_Days", "Father_Days"), colnames(data))
par_amt_idx <- match(c("Mother_Amt", "Father_Amt"), colnames(data))

# Replacing NA values in parent columns with 0 only if respondent answered "No"
# when asked if their biological parents drank
data[data[par_idx] == "No", par_days_idx] <- 0
data[data[par_idx] == "No", par_amt_idx] <- "0"

# Calculating maximum number of siblings in the data set
sib_num <- match("Num_Sibs", colnames(data))
max_sibs <- max(data[sib_num])

# Locating columns of sibling drinking habits
sib_cols <- c("Sib1_Drink", "Sib2_Drink", "Sib3_Drink", "Sib4_Drink",
              "Sib5_Drink", "Sib6_Drink", "Sib7_Drink", "Sib8_Drink",
              "Sib9_Drink", "Sib10_Drink")
sib_days_cols <- c("Sib1_Days", "Sib2_Days", "Sib3_Days", "Sib4_Days",
                   "Sib5_Days", "Sib6_Days", "Sib7_Days", "Sib8_Days",
                   "Sib9_Days", "Sib10_Days")
sib_amt_cols <- c("Sib1_Amt", "Sib2_Amt", "Sib3_Amt", "Sib4_Amt", "Sib5_Amt",
                  "Sib6_Amt", "Sib7_Amt", "Sib8_Amt", "Sib9_Amt", "Sib10_Amt")
sib_idx <- match(sib_cols, colnames(data))
sib_days_idx <- match(sib_days_cols, colnames(data))
sib_amt_idx <- match(sib_amt_cols, colnames(data))

# Clearing data of columns that exceed maximum number of siblings
data <- data[-seq(sib_idx[max_sibs + 1], sib_amt_idx[10])]
sib_idx <- sib_idx[seq(1, max_sibs)]
sib_days_idx <- sib_days_idx[seq(1, max_sibs)]
sib_amt_idx <- sib_amt_idx[seq(1, max_sibs)]

# Replacing NA values in sibling columns with 0 only if respondent answered
# "No" when asked if they had siblings that drank AND if the sibling value
# being replaced does not create a sibling when there wasn't one (i.e. if the
# number of reported siblings is less than the number of NA values)
for (i in seq(2, length(sib_amt_idx))) {
    data[data[sib_idx[i - 1]] == "Unsure" & data[sib_num] <= i - 1,
            sib_idx[i]] <- "DNE"
    data[data[sib_idx[i - 1]] == "Unsure" & data[sib_num] > i - 1,
            sib_idx[i]] <- "Unsure"
    data[data[sib_idx[i - 1]] == "No" & data[sib_num] == i - 1,
            sib_idx[i]] <- "DNE"
    data[data[sib_idx[i - 1]] == "No" & data[sib_num] == i - 1,
         sib_days_idx[i - 1]] <- 0
    data[data[sib_idx[i - 1]] == "No" & data[sib_num] == i - 1,
         sib_amt_idx[i - 1]] <- "0"
    data[data[sib_idx[i - 1]] == "No" & data[sib_num] > i - 1,
            sib_idx[i]] <- "No"
    data[data[sib_idx[i - 1]] == "No" & data[sib_num] > i - 1,
            sib_days_idx[i]] <- 0
    data[data[sib_idx[i - 1]] == "No" & data[sib_num] > i - 1,
            sib_amt_idx[i]] <- "0"
    data[data[sib_idx[i - 1]] == "No" & data[sib_num] < i - 1,
            sib_idx[i]] <- "DNE"
    data[data[sib_idx[i - 1]] == "No" & data[sib_num] < i - 1,
            sib_idx[i - 1]] <- "DNE"
    data[data[sib_idx[i - 1]] == "DNE", sib_idx[i]] <- "DNE"
    if (i == length(sib_amt_idx)) {
        data[data[sib_idx[i]] == "No" & data[sib_num] == i - 1,
             sib_idx[i]] <- "DNE"
    }
}

# Locating columns of grandparent drinking habits
gp_idx <- na.omit(match(c("GP1_Drink", "GP2_Drink", "GP3_Drink", "GP4_Drink"),
                        colnames(data)))
gp_days_idx <- na.omit(match(c("GP1_Days", "GP2_Days", "GP3_Days", "GP4_Days"),
                             colnames(data)))
gp_amt_idx <- na.omit(match(c("GP1_Amt", "GP2_Amt", "GP3_Amt", "GP4_Amt"),
                            colnames(data)))

# Carrying through "No" and "Unsure" answers through columns and replacing NA
# values with 0 only if respondent answered "No" when asked if they had
# grandparents that drank
for (i in seq_len(length(gp_idx))) {
    if (i > 1) {
        data[data[gp_idx[i - 1]] == "Unsure", gp_idx[i]] <- "Unsure"
        data[data[gp_idx[i - 1]] == "No", gp_idx[i]] <- "No"
    }
    data[data[gp_idx[i]] == "No", gp_days_idx[i]] <- 0
    data[data[gp_idx[i]] == "No", gp_amt_idx[i]] <- "0"
}

# Changing non-male and non-female genders to "other" for data simplicity
data$Gender[which(data$Gender != "Male" & data$Gender != "Female")] <- "Other"

# Changing the timestamp column to subject number
data$Subject <- seq_len(nrow(data))
mean_days <- c(mean(data$Pers_Days), mean(data$Mother_Days),
               mean(data$Father_Days), mean(data$Sib1_Days),
               mean(data$Sib2_Days), mean(data$Sib3_Days),
               mean(data$Sib4_Days), mean(data$Sib5_Days),
               mean(data$Sib6_Days), mean(data$Sib7_Days),
               mean(data$Sib8_Days), mean(data$Sib9_Days),
               mean(data$Sib10_Days), mean(data$GP1_Days),
               mean(data$GP2_Days), mean(data$GP3_Days),
               mean(data$GP4_Days))

# Calculating "means" of drinks/day of subject and relatives
d_mean <- function(x, col_names) {
    arr <- c(0)
    for (i in seq_len(length(col_names))) {
        tmp_arr <- x[, col_names[i]]
        tmp_arr[tmp_arr == "0"] <- 0
        tmp_arr[tmp_arr == "1 or less than 1"] <- 1
        tmp_arr[tmp_arr == "2-4"] <- 2
        tmp_arr[tmp_arr == "5-7"] <- 3
        tmp_arr[tmp_arr == "8-10"] <- 4
        tmp_arr[tmp_arr == "11+"] <- 5
        arr <- c(arr, mean(as.integer(tmp_arr), na.rm = TRUE))
    }
    return(arr[-1])
}
mean_amts <- c(d_mean(data, "Pers_Amt"), d_mean(data, par_amt_idx),
               d_mean(data, sib_amt_idx), d_mean(data, gp_amt_idx)) + 1
fig1 <- ggplot(data, aes(x = Pers_Days, y = Pers_Amt)) +
    geom_point(aes(size = Father_Amt,
                   alpha = Father_Days,
                   colour = "#65A5E2"),
               position = position_jitter(w = 0.3, h = 0.3)) +
    geom_point(aes(size = Mother_Amt,
                   alpha = Mother_Days,
                   colour = "#E57694"),
               position = position_jitter(w = 0.3, h = 0.3)) +
    geom_vline(xintercept = mean_days[1], linetype = "dotdash",
               colour = "black") +
    geom_vline(xintercept = mean_days[2], linetype = "dotdash",
               colour = "#E57694") +
    geom_vline(xintercept = mean_days[3], linetype = "dotdash",
               colour = "#65A5E2") +
    geom_hline(yintercept = mean_amts[1], linetype = "dotdash",
               colour = "black") +
    geom_hline(yintercept = mean_amts[2], linetype = "dotdash",
               colour = "#E57694") +
    geom_hline(yintercept = mean_amts[3], linetype = "dotdash",
               colour = "#65A5E2") +
    scale_y_discrete(labels = c("0", "\u2264 1", "2-4", "5-7", "8-10", "11+")) +
    scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5, 6, 7),
                       labels = c("0", "1", "2", "3", "4", "5", "6", "7")) +
    scale_size_manual(name = "Drinks/Day - Relatives",
                      values = c("0" = 1,
                                 "1 or less than 1" = 3,
                                 "2-4" = 5,
                                 "5-7" = 7,
                                 "8-10" = 9,
                                 "11+" = 11)) +
    scale_colour_identity(name = "Relative",
                          breaks = c("#65A5E2", "#E57694"),
                          labels = c("Father", "Mother"),
                          guide = "legend") +
    labs(title = "",
         subtitle = "",
         caption = "",
         x = "Days/Week - Subject",
         y = "Drinks/Day - Subject",
         alpha = "Days/Week - Relatives") +
    theme(plot.title = element_text(color = "#2c3136", size = 16,
                                    family = "karla"),
          axis.title.x = element_text(color = "#2c3136", size = 10,
                                      family = "karla"),
          axis.title.y = element_text(color = "#2c3136", size = 10,
                                      angle = 90, family = "karla"),
          legend.title = element_text(color = "#2c3136", size = 9,
                                      family = "karla"),
          legend.position = "right",
          legend.justification = "left",
          legend.margin = margin(0,0,0,0),
          legend.box.margin = margin(-10,0,-10,-10),
          legend.key.size = unit(0.8, "line"))
print(fig1)
```